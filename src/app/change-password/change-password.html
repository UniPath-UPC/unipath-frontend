<div class="page-wrapper">
  <div class="change-password-container">
    <!-- Paso 1: Solicitud de correo -->
    <div *ngIf="etapa === 1" class="form-stage fade-in">
      <h2>Restablecer contraseña</h2>
      <p class="descripcion-etapa">
        Ingresa el correo con el que te registraste para enviarte un código de verificación.
      </p>

      <input
        type="email"
        placeholder="Correo electrónico"
        [(ngModel)]="correo"
        class="form-control"
        (input)="mensaje = ''"
      />

      <button
        (click)="enviarCorreo()"
        class="btn btn-primary d-flex align-items-center justify-content-center"
        [disabled]="enviando || !correo"
      >
        <span *ngIf="!enviando">Enviar código</span>
        <span *ngIf="enviando" class="d-flex align-items-center gap-2">
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          Enviando...
        </span>
      </button>
    </div>

    <!-- Paso 2: Verificación de código -->
    <div *ngIf="etapa === 2" class="form-stage fade-in">
      <h2>Verificación de código</h2>
      <p class="descripcion-etapa">Revisa tu correo e ingresa el código.</p>

      <div class="otp-container">
        <input class="otp-input" id="otp0" maxlength="1" type="text"
               (input)="onInputChange($event, 0)" (keydown)="onKeyDown($event, 0)" autocomplete="off" />
        <input class="otp-input" id="otp1" maxlength="1" type="text"
               (input)="onInputChange($event, 1)" (keydown)="onKeyDown($event, 1)" autocomplete="off" />
        <input class="otp-input" id="otp2" maxlength="1" type="text"
               (input)="onInputChange($event, 2)" (keydown)="onKeyDown($event, 2)" autocomplete="off" />
        <input class="otp-input" id="otp3" maxlength="1" type="text"
               (input)="onInputChange($event, 3)" (keydown)="onKeyDown($event, 3)" autocomplete="off" />
        <input class="otp-input" id="otp4" maxlength="1" type="text"
               (input)="onInputChange($event, 4)" (keydown)="onKeyDown($event, 4)" autocomplete="off" />
        <input class="otp-input" id="otp5" maxlength="1" type="text"
               (input)="onInputChange($event, 5)" (keydown)="onKeyDown($event, 5)" autocomplete="off" />
      </div>

      <button (click)="validarCodigo()" class="btn btn-primary">
        Validar código
      </button>
    </div>

    <!-- Paso 3: Nueva contraseña -->
    <div *ngIf="etapa === 3" class="form-stage fade-in">
      <h2>Crear nueva contraseña</h2>
      <p class="descripcion-etapa">
        Ingresa y confirma tu nueva contraseña de forma segura.
      </p>

      <div class="input-password-wrapper">
        <input
          [type]="verPassword ? 'text' : 'password'"
          placeholder="Nueva contraseña"
          [(ngModel)]="nuevaContrasena"
          class="form-control"
          (ngModelChange)="onPasswordInput()"
        />
        <span class="toggle-password" (click)="verPassword = !verPassword">
          <i [ngClass]="verPassword ? 'bi bi-eye-slash' : 'bi bi-eye'"></i>
        </span>
      </div>

      <!-- Reglas de contraseña -->
      <div class="password-rules">
        <div class="rule" [ngClass]="passwordTouched ? (lenOk ? 'ok' : 'bad') : ''">
          • Mínimo 8 caracteres
        </div>
        <div class="rule" [ngClass]="passwordTouched ? (upperOk ? 'ok' : 'bad') : ''">
          • Al menos una mayúscula
        </div>
      </div>

      <div class="input-password-wrapper">
        <input
          [type]="verConfirmacion ? 'text' : 'password'"
          placeholder="Confirmar contraseña"
          [(ngModel)]="confirmarContrasena"
          class="form-control"
          (input)="mensaje = ''"
        />
        <span class="toggle-password" (click)="verConfirmacion = !verConfirmacion">
          <i [ngClass]="verConfirmacion ? 'bi bi-eye-slash' : 'bi bi-eye'"></i>
        </span>
      </div>

      <button
        (click)="cambiarContrasena()"
        class="btn btn-success"
        [disabled]="!lenOk || !upperOk || !nuevaContrasena || !confirmarContrasena"
      >
        Cambiar contraseña
      </button>
    </div>

    <div *ngIf="mensaje" class="alert alert-danger mt-3">{{ mensaje }}</div>
  </div>
</div>
